(()=>{"use strict";let e=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")),"");const t={id:e(),title:"Пустой продукт",maker:"Нонэйм",energy:0,protein:0,fat:0,carb:0,measure:"гр.",measureCount:1},n=()=>JSON.parse(localStorage.getItem("products")||"[]"),i=e=>{const i=n();let l=i.find((t=>t.id===e));return l||(l=i.length<=0?t:i[0]),l},l=e=>{const{count:t=0,productId:n=-1}=e,l=i(n),{measureCount:r,energy:s,protein:a,fat:c,carb:d}=l;return{energy:r*s*t/100,protein:r*a*t/100,fat:r*c*t/100,carb:r*d*t/100}},r=({ingredients:e})=>e.reduce(((e,t)=>{const n=l(t);return{energy:e.energy+n.energy,protein:e.protein+n.protein,fat:e.fat+n.fat,carb:e.carb+n.carb}}),{energy:0,protein:0,fat:0,carb:0}),s=e=>e.reduce(((e,t)=>{const n=r(t);return{energy:e.energy+n.energy,protein:e.protein+n.protein,fat:e.fat+n.fat,carb:e.carb+n.carb}}),{energy:0,protein:0,fat:0,carb:0}),a=e=>({energy:e.energy.toFixed(1),protein:e.protein.toFixed(1),fat:e.fat.toFixed(1),carb:e.carb.toFixed(1)}),c=t=>({id:e(),title:t.title,amount:Object.assign({},t.amount),ingredients:t.ingredients.map((t=>Object.assign({},t,{id:e})))}),d="beforeend",o=(e,t,n)=>{switch(e instanceof k&&(e=e.getElement()),t instanceof k&&(t=t.getElement()),n){case"afterbegin":e.prepend(t);break;case d:e.append(t)}},h=(e,t)=>{t instanceof k&&(t=t.getElement()),e instanceof k&&(e=e.getElement());const n=t.parentElement;if(null===n||null===t||null===e)throw new Error("Can't replace unesisting elements");n.replaceChild(e,t)},u=e=>{if(!(e instanceof k))throw new Error("Can remove only components");e.getElement().remove(),e.removeElement()};class k{constructor(){if("Abstract"===new.target)throw new Error("Can't instantiate Abstract, only concrete one.");this._element=null,this._callback={}}getTemplate(){throw new Error("Method not implemented: getTemplate")}getElement(){return null===this._element&&(this._element=(e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstChild})(this.getTemplate())),this._element}removeElement(){this._element=null}}class m extends k{constructor(e){super(),this._chunks=e}getTemplate(){return(e=>{const{energy:t,protein:n,fat:i,carb:l}=a(s(e));return`<div class="amount">\n    <div class="amount-energy">Калории: ${t}</div>\n    <div class="amount-protein">Белки: ${n}</div>\n    <div class="amount-fat">Жиры: ${i}</div>\n    <div class="amount-carb">Углеводы: ${l}</div>\n  </div>`})(this._chunks)}}const _=(e,t)=>{const n=e.findIndex((e=>e.id===t.id));return-1===n?e:[...e.slice(0,n),t,...e.slice(n+1)]},p=(e,t)=>[...e,t],C=(e,t)=>{const n=e.findIndex((({id:e})=>e===t.id));return-1===n?e:[...e.slice(0,n),...e.slice(n+1)]};class g extends k{getTemplate(){return'<ul class="chunk-list"></ul>'}}const b=()=>JSON.parse(localStorage.getItem("templates")||"[]");class v extends k{constructor(){super(),this._clickButtonHandler=this._clickButtonHandler.bind(this),this._clickCreateButtonHandler=this._clickCreateButtonHandler.bind(this),this._loadTemplateClickHandler=this._loadTemplateClickHandler.bind(this),this._removeTemplateClickHandler=this._removeTemplateClickHandler.bind(this)}getTemplate(){return`<form class="add-chunk-form">\n  <fieldset>\n    <select name="templates" class="templates">\n      ${b().reduce(((e,t)=>e+`<option value="${t.id}">${t.title}</option>`),'<option value="-1">Выберите шаблон...</option>')}\n    </select>\n    <button type="button" class="btn btn-load btn-success">Загрузить</button>\n    <button type="button" class="btn btn-delete btn-error">Удалить</button>\n  </fieldset>\n  <fieldset>\n    <input type="text" class="form-input" placeholder="Введите название группы">\n    <button type="submit" class="btn btn-chunk btn-success">Добавить группу</button>\n  </fieldset>\n  <fieldset>\n    <button type="button" class="btn btn-create btn-success">Создать новый день</button>\n  </fieldset>\n</form>`}_getSelectedTemplateId(){return this.getElement().querySelector(".templates").value}_clickButtonHandler(e){e.preventDefault();const t=this.getElement().querySelector(".form-input").value;this._callback.clickButton(t)}_clickCreateButtonHandler(e){e.preventDefault(),this._callback.clickCreateButton()}_loadTemplateClickHandler(e){e.preventDefault();const t=this._getSelectedTemplateId();this._callback.loadTemplateClick(t)}_removeTemplateClickHandler(e){e.preventDefault();const t=this._getSelectedTemplateId();this._callback.removeTemplateClick(t)}setClickButtonHandler(e){this._callback.clickButton=e,this.getElement().addEventListener("submit",this._clickButtonHandler)}setClickCreateButtonHandler(e){this._callback.clickCreateButton=e,this.getElement().querySelector(".btn-create").addEventListener("click",this._clickCreateButtonHandler)}setLoadTemplateClickHandler(e){this._callback.loadTemplateClick=e,this.getElement().querySelector(".btn-load").addEventListener("click",this._loadTemplateClickHandler)}setRemoveTemplateClickHandler(e){this._callback.removeTemplateClick=e,this.getElement().querySelector(".btn-delete").addEventListener("click",this._removeTemplateClickHandler)}}class H extends k{constructor(e={}){super(),this._chunk=e,this._addClickHandler=this._addClickHandler.bind(this),this._removeClickHandler=this._removeClickHandler.bind(this),this._addToTemplateClickHandler=this._addToTemplateClickHandler.bind(this)}getTemplate(){return(e=>{const{id:t,title:n}=e;console.log("test",e,a(r(e)));const{energy:i,protein:l,fat:s,carb:c}=a(r(e));return`<li class="chunk-list-item" data-id="${t}">\n    <div class="chunk-header">\n      <h2 class="chunk-title">${n} <a href="#" class="small">[ + ]</a></h2>\n      <table class="chunk-info-table">\n        <tr>\n          <th>Калории</th>\n          <th>Белки</th>\n          <th>Жиры</th>\n          <th>Углеводы</th>\n        </tr>\n        <tr>\n          <td>${i}</td>\n          <td>${l}</td>\n          <td>${s}</td>\n          <td>${c}</td>\n        </tr>\n      </table>\n      <div class="chunk-controls">\n        <button type="button" class="btn btn-add"></button>\n        <button type="button" class="btn btn-remove"></button>\n      </div>\n    </div>\n    <ul class="component-list"></ul>\n  </li>`})(this._chunk)}_addClickHandler(e){e.preventDefault(),this._callback.addClick()}_removeClickHandler(e){e.preventDefault(),this._callback.removeClick()}_addToTemplateClickHandler(e){e.preventDefault(),this._callback.addToTemplateClick(this._chunk)}setAddClickHandler(e){this._callback.addClick=e,this.getElement().querySelector(".btn-add").addEventListener("click",this._addClickHandler)}setRemoveClickHandler(e){this._callback.removeClick=e,this.getElement().querySelector(".btn-remove").addEventListener("click",this._removeClickHandler)}setAddToTemplateClickHandler(e){this._callback.addToTemplateClick=e,this.getElement().querySelector("a.small").addEventListener("click",this._addToTemplateClickHandler)}}class f extends k{constructor(e){super(),this._ingredient=e,this._editClickHandler=this._editClickHandler.bind(this),this._removeClickHandler=this._removeClickHandler.bind(this)}getTemplate(){return(e=>{const{productId:t,count:n}=e,r=i(t),{title:s,maker:c="",measure:d}=r,o=c?`, ${c}`:"",{energy:h,protein:u,fat:k,carb:m}=a(l(e));return`<li class="ingredient-list-item">\n    <div class="ingredient-top">\n      <h3 class="ingredient-title">${s}${o}</h3>\n      <div class="ingredient-count">\n        <span>${n}</span> ${d}\n      </div>\n    </div>\n\n    <div class="ingredient-bottom">\n      <table class="ingredient-info-table">\n        <tr>\n          <th>Калории</th>\n          <th>Белки</th>\n          <th>Жиры</th>\n          <th>Углеводы</th>\n        </tr>\n        <tr>\n          <td>${h}</td>\n          <td>${u}</td>\n          <td>${k}</td>\n          <td>${m}</td>\n        </tr>\n      </table>\n\n      <div class="controls">\n        <button class="btn btn-remove"></button>\n      </div>\n    </div>\n  </li>`})(this._ingredient)}_editClickHandler(e){e.preventDefault(),this._callback.editClick(this._ingredient)}_removeClickHandler(e){e.preventDefault(),this._callback.removeClick(this._ingredient)}setEditClickHandler(e){this._callback.editClick=e;const t=this.getElement().querySelector(".ingredient-title"),n=this.getElement().querySelector(".ingredient-count");t.addEventListener("click",this._editClickHandler),n.addEventListener("click",this._editClickHandler)}setRemoveClickHandler(e){this._callback.removeClick=e,this.getElement().querySelector(".btn-remove").addEventListener("click",this._removeClickHandler)}}class T extends k{constructor(e=0){super(),this._selectedProductId=e}getTemplate(){return(e=>{let t="";const i=n();for(const n of i.values()){const{id:i,title:l,maker:r=""}=n;t+=`<option value="${i}" ${i===e?"selected":""}>${l}, ${r}</option>`}return`<select>${t}</select>`})(this._selectedProductId)}}class y extends k{constructor(e){super(),this._ingredient=e,this._saveClickHandler=this._saveClickHandler.bind(this),this._cancelClickHandler=this._cancelClickHandler.bind(this)}getTemplate(){return(e=>{const{id:t,productId:n=-1,count:r}=e,s=i(n),{measure:c}=s,{energy:d,protein:o,fat:h,carb:u}=a(l(e));return`<li class="ingredient-list-item" data-id="${t}">\n    <div class="ingredient-top">\n      ${new T(n).getTemplate()}\n      <div class="ingredient-count">\n        <input type="number" name="count" style="font-size: 16px; width: 50px;" value="${r}" onclick="this.select();" inputmode="numeric"> ${c}\n      </div>\n    </div>\n\n    <div class="ingredient-bottom">\n      <table class="ingredient-info-table">\n        <tr>\n          <th>Калории</th>\n          <th>Белки</th>\n          <th>Жиры</th>\n          <th>Углеводы</th>\n        </tr>\n        <tr>\n          <td>${d}</td>\n          <td>${o}</td>\n          <td>${h}</td>\n          <td>${u}</td>\n        </tr>\n      </table>\n\n      <div class="controls">\n        <button class="btn btn-save btn-success btn-middle">Сохранить</button>\n        <button class="btn btn-cancel btn-error btn-middle">Отменить</button>\n      </div>\n    </div>\n  </li>`})(this._ingredient)}_saveClickHandler(e){e.preventDefault();const t=this.getElement().querySelector("select"),n=this.getElement().querySelector('input[name="count"]'),i={productId:t.value,count:n.value};this._callback.saveClick(Object.assign({},this._ingredient,i))}_cancelClickHandler(e){e.preventDefault(),this._callback.cancelClick(this._ingredient)}setSaveClickHandler(e){this._callback.saveClick=e,this.getElement().querySelector(".btn-save").addEventListener("click",this._saveClickHandler),this.getElement().querySelector('input[name="count"]').addEventListener("keydown",(e=>{13===e.keyCode&&this._saveClickHandler(e)}))}setCancelClickHandler(e){this._callback.cancelClick=e,this.getElement().querySelector(".btn-cancel").addEventListener("click",this._cancelClickHandler)}}class E{constructor(e,t){this._container=e,this._changeData=t,this._chunkComponent=null,this._ingredientComponentList={},this._addIngredientClickHandler=this._addIngredientClickHandler.bind(this),this._removeChunkClickHandler=this._removeChunkClickHandler.bind(this),this._editIngredientClickHandler=this._editIngredientClickHandler.bind(this),this._removeIngredientClickHandler=this._removeIngredientClickHandler.bind(this),this._saveIngredientClickHandler=this._saveIngredientClickHandler.bind(this),this._cancelIngredientClickHandler=this._cancelIngredientClickHandler.bind(this),this._addToTemplateClickHandler=this._addToTemplateClickHandler.bind(this)}init(e){this._chunk=e,this._products=n(),this._editIngredientComponent=null,this._renderChunk()}destroy(){Object.values(this._ingredientComponentList).forEach((e=>u(e))),this._ingredientComponentList={},u(this._chunkComponent)}_renderChunk(){this._chunkComponent=new H(this._chunk),this._chunkComponent.setAddClickHandler(this._addIngredientClickHandler),this._chunkComponent.setRemoveClickHandler(this._removeChunkClickHandler),this._chunkComponent.setAddToTemplateClickHandler(this._addToTemplateClickHandler),o(this._container,this._chunkComponent,d),this._chunk.ingredients.forEach((e=>{this._renderIngredient(e)}))}_renderIngredient(e){const t=new f(e);t.setEditClickHandler(this._editIngredientClickHandler),t.setRemoveClickHandler(this._removeIngredientClickHandler),o(this._chunkComponent,t,d),this._ingredientComponentList[e.id]=t}_addIngredientClickHandler(){if(0===this._products.length)return void alert("Список продуктов пуст! Сначала нужно заполнить его!");const t={id:e(),productId:-1,count:0};this._chunk.ingredients=p(this._chunk.ingredients,t),this._changeData(this._chunk)}_removeChunkClickHandler(){this._changeData(this._chunk,"remove")}_editIngredientClickHandler(e){this._replaceToEdit(e)}_replaceToEdit(e){if(this._editIngredientComponent)return void this._changeData(this._chunk);this._editIngredientComponent=new y(e),this._editIngredientComponent.setSaveClickHandler(this._saveIngredientClickHandler),this._editIngredientComponent.setCancelClickHandler(this._cancelIngredientClickHandler);const t=this._ingredientComponentList[e.id];h(this._editIngredientComponent,t),u(t),this._ingredientComponentList[e.id]=this._editIngredientComponent}_replaceFromEdit(e){const t=new f(e);t.setEditClickHandler(this._editIngredientClickHandler),t.setRemoveClickHandler(this._removeIngredientClickHandler),h(t,this._editIngredientComponent),u(this._editIngredientComponent),this._ingredientComponentList[e.id]=t,this._editIngredientComponent=null}_removeIngredientClickHandler(e){this._chunk.ingredients=C(this._chunk.ingredients,e),this._changeData(this._chunk)}_saveIngredientClickHandler(e){this._chunk.ingredients=_(this._chunk.ingredients,e),this._changeData(this._chunk)}_cancelIngredientClickHandler(e){this._replaceFromEdit(e)}_addToTemplateClickHandler(e){(e=>{const t=b();t.push(c(e)),localStorage.setItem("templates",JSON.stringify(t))})(e),this._changeData(this._chunk)}}n();const I=JSON.parse(localStorage.getItem("chunks")||"[]"),S=document.querySelector(".main");let $=null;const D=e=>{$&&u($),$=new m(e),o(S,$,d)};D(I);const L=new class{constructor(e,t){this._container=e,this._changeData=t,this._chunkPresenter={},this._chunkListComponent=new g,this._addChunkFormComponent=new v,this._chunkUpdateHandler=this._chunkUpdateHandler.bind(this),this._createNewDayHandler=this._createNewDayHandler.bind(this),this._loadTemplateHandler=this._loadTemplateHandler.bind(this),this._removeTemplateHandler=this._removeTemplateHandler.bind(this)}init(e){this._chunks=e,this._clearList(),this._renderChunkList(),this._renderAddChunkForm()}_clearList(){Object.values(this._chunkPresenter).forEach((e=>e.destroy())),this._chunkPresenter={},u(this._addChunkFormComponent)}_renderChunk(e){const t=new E(this._chunkListComponent,this._chunkUpdateHandler);t.init(e),this._chunkPresenter[e.id]=t}_renderChunkList(){o(this._container,this._chunkListComponent,d),this._chunks.forEach((e=>this._renderChunk(e)))}_renderAddChunkForm(){o(this._chunkListComponent,this._addChunkFormComponent,d),this._addChunkFormComponent.setClickButtonHandler((e=>this._addChunkHandler(e))),this._addChunkFormComponent.setClickCreateButtonHandler(this._createNewDayHandler),this._addChunkFormComponent.setLoadTemplateClickHandler(this._loadTemplateHandler),this._addChunkFormComponent.setRemoveTemplateClickHandler(this._removeTemplateHandler)}_chunkUpdateHandler(e,t="update"){switch(t){case"update":this._changeData(_(this._chunks,e));break;case"remove":this._changeData(C(this._chunks,e))}}_addChunkHandler(t){if(!t)return alert("Введите название группы!");this._changeData(p(this._chunks,(t=>({id:e(),title:t,ingredients:[]}))(t)))}_createNewDayHandler(){const e=(e=>{const t=this._chunks.map((e=>c(e)));return{amount:s(t),chunks:t}})(),t=new Date;t.setDate(t.getDate()-1);const n=`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}_${t.getHours()}-${t.getMinutes()}`,i=JSON.parse(localStorage.getItem("story")||"{}");i[n]=e,localStorage.setItem("story",JSON.stringify(i)),this._changeData([])}_loadTemplateHandler(e){if(!e||"-1"===e)return alert("Выберите шаблон!");const t=(e=>b().find((t=>t.id===e))||null)(e);if(!t)return alert("Шаблон не найден!");this._changeData(p(this._chunks,t))}_removeTemplateHandler(e){if(!e||"-1"===e)return alert("Выберите шаблон!");(e=>{const t=((e,t)=>{const n=e.findIndex((e=>e.id===t));return-1===n?e:[...e.slice(0,n),...e.slice(n+1)]})(b(),e);localStorage.setItem("templates",JSON.stringify(t))})(e),u(this._addChunkFormComponent),this._renderAddChunkForm()}}(S,(e=>{D(I),(e=>{localStorage.setItem("chunks",JSON.stringify(e))})(e),L.init(e)}));L.init(I)})();